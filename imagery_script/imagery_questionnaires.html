<!DOCTYPE html>
<html>
<head>
  <title>Imagery Questionnaires</title>
  <meta charset="UTF-8"> <!-- Specify UTF-8 encoding -->
  <!-- jsPsych core library -->
  <script src="https://unpkg.com/jspsych@7.3.4"></script>
  <link href="https://unpkg.com/jspsych@7.3.4/css/jspsych.css" rel="stylesheet" type="text/css"/>
  <script src="https://unpkg.com/@jspsych/plugin-survey-likert@1.1.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-multi-choice@1.1.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-multi-select@1.1.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-html-button-response@1.1.3"></script>
  <script src="https://unpkg.com/@jspsych/plugin-fullscreen@1.1.0"></script>
  <script src="https://unpkg.com/@jspsych/plugin-survey-text@1.1.1"></script>
  <script src="questionnaires.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.0.2/papaparse.min.js"></script>
  <style>
  /* General Style Adjustments */
  .jspsych-display-element {
    font-family: Arial, sans-serif; /* Improving readability */
/*    font-size: 30px;*/
  }

  /* Custom style for vviq instructions */
  .vviq-instructions {
    font-weight: bold;
    font-size: larger;
    margin-bottom: 20px;
  }

  /*Add some space from the bottom of likert button*/
  #jspsych-survey-likert-next{
    margin-bottom: 20px;
  }

  /*Keep likert scales consistent for each page using width*/
  #jspsych-survey-likert-form{
    display: inline-block;
    width: 700px;
    max-width: 700px;;
  }

  /*Add some space from the bottom of vviq button*/
  #jspsych-survey-multi-choice-next{
    margin-bottom: 20px;
  }

</style>
</head>
<body>

  <script>

      // Create a timeline
      let timeline = [];
      let urlParams = new URLSearchParams(window.location.search);
      let sona_id = urlParams.get('sona_id'); // Correctly retrieves SONA ID from URL
      let subject_id = urlParams.get('subject_id'); // Retrieves Subject ID from URL

      function saveData(name, data, callback) {
          var xhr = new XMLHttpRequest();
          xhr.open('POST', 'write_data.php');
          xhr.setRequestHeader('Content-Type', 'application/json');
          xhr.onload = function() {
              if (xhr.status == 200) {
                  // Data saved successfully
                  if (callback && typeof callback === "function") {
                      callback(); // Call the callback function
                  }
              } else {
                  // Handle error, maybe retry or log
                  console.error("Data save failed with status: " + xhr.status);
              }
          };
          // Use 'data' parameter that function receives, not 'reshapedData'
          xhr.send(JSON.stringify({filename: name, filedata: data}));
      }



      function reshapeDataAndDisplay() {
          // Fetch all data for Likert and Multi-Choice responses
          var allData = jsPsych.data.get().filterCustom(function(trial) {
            return trial.trial_type === 'survey-likert' || trial.trial_type === 'survey-multi-choice' || trial.trial_type === 'survey-multi-select' || trial.trial_type === 'survey-text'}).values();
          var reshapedData = [];

          allData.forEach(function(trial) {
              Object.keys(trial.response).forEach(function(questionKey) {
                  var index = parseInt(questionKey.replace('Q', ''), 10);
                  reshapedData.push({
                      subject_id: subject_id,
                      sona_id: sona_id,
                      trial_index: trial.trial_index,
                      time_elapsed: trial.time_elapsed,
                      internal_node_id: trial.internal_node_id,
                      response: trial.response[questionKey],
                      item_id: trial.item_ids ? trial.item_ids[index] : 'N/A',
                      item: trial.items ? trial.items[index] : 'N/A',
                      category: trial.categories ? trial.categories[index] : 'N/A',
                      questionnaire: trial.questionnaires ? trial.questionnaires[index] : 'N/A'
                  });
              });
          });

          var jsonData = JSON.stringify(reshapedData, null, 2);
          var pre = document.createElement('pre');
          pre.textContent = jsonData;
          document.body.innerHTML = '';
          document.body.appendChild(pre);

          return reshapedData;
      }

       

      var introduction = {
        type: jsPsychHtmlButtonResponse,
        stimulus: '<p><b>Welcome to the second part of the study!</b></p><p>In this section, you will be presented with a series of statements. Please indicate your level of agreement or disagreement with each one.</p>',
        choices: ['Continue'],

        on_start: function() {
        // set progress bar to 0 at the start of experiment
        jsPsych.setProgressBar(0);
        },
      };
      timeline.push(introduction);
    
     
     var enter_fullscreen = {
        type: jsPsychFullscreen,
        fullscreen_mode: true
      }
      timeline.push(enter_fullscreen);

        
      // Shuffle the items array
      function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [array[i], array[j]] = [array[j], array[i]]; // Swap elements
        }
      }


      // Shuffle the osivq array
      shuffleArray(osivq);

      // Function to generate a trial for a chunk of osivq items
      function generateOsivqTrial(itemsChunk) {
        return {
          type: jsPsychSurveyLikert,
          questions: itemsChunk.map(item => ({
            prompt: item.item,
            labels: ['1', '2', '3', '4', '5'],
            required: true
          })),
          on_finish: function(data) {
            // Attach additional data to the data object
            data.item_ids = itemsChunk.map(i => i.item_id);
            data.items = itemsChunk.map(i => i.item);
            data.categories = itemsChunk.map(i => i.category);
            data.questionnaires = itemsChunk.map(i => i.questionnaire);

            //set progress bar value
            var curr_progress_bar_value = jsPsych.getProgressBarCompleted();
            jsPsych.setProgressBar(curr_progress_bar_value + (1/20));

          }
        };
      }

      // Chunk osivq items into groups of 5 and add to timeline
      while (osivq.length > 0) {
        let itemsChunk = osivq.splice(0, 6); // Get next chunk of 5 items
        timeline.push(generateOsivqTrial(itemsChunk));
      }

      shuffleArray(irq); // Shuffle the items initially

      /// Function to generate a trial for a chunk of items
      function generateIrqTrial(itemsChunk) {
        return {
          type: jsPsychSurveyLikert,
          questions: itemsChunk.map(item => ({
            prompt: item.item,
            labels: ['1', '2', '3', '4', '5'],
            required: true
          })),
          on_finish: function(data) {
            data.item_ids = itemsChunk.map(i => i.item_id);
            data.items = itemsChunk.map(i => i.item);
            data.categories = itemsChunk.map(i => i.category);
            data.questionnaires = itemsChunk.map(i => i.questionnaire);

            //set progress bar value
            var curr_progress_bar_value = jsPsych.getProgressBarCompleted();
            jsPsych.setProgressBar(curr_progress_bar_value + (1/20));
           
          }
        };
      }

      // Chunk items into groups of 4 and add to timeline
      while (irq.length > 0) {
        let itemsChunk = irq.splice(0, 5); // Get next chunk of 4 items
        timeline.push(generateIrqTrial(itemsChunk));
      }


      // Define the thank you screen
      var thankYouScreen = {
        type: jsPsychHtmlButtonResponse,
        stimulus: '<p><b>Thank you! Let\'s move to the next section.<br><br>Please read the instructions before moving to the next page.<br><br></b>Visual imagery refers to the ability to visualize, that is, the ability to form mental pictures, or to “see in the minds\’ eye.”<br><br>The aim of this test is to determine the vividness of your visual imagery. The items of the test will possibly bring certain images to your mind.<br><br>You are asked to rate the vividness of each image by reference to the 5-point scale given below: No image at all/ Vague and dim/ Moderately clear and vivid/ Reasonably clear and vivid/ Perfectly clear & vivid as if I was actually seeing it.<br><br>After reading each item, close your eyes for a moment, try to visualize the item, and then open your eyes and rate the item.</p>',
        choices: ['Continue']
      };
      timeline.push(thankYouScreen);

      // Instruction messages for each VVIQ screen
      const vviqInstructions = [
        "In answering items 1 to 4, think of some relative or friend whom you frequently see and consider carefully the picture that comes your mind’s eye.",
        "In answering items 5 to 8, visualize a sun. Consider the picture that comes before you minds’ eye.",
        "In answering items 9 to 12, think of the front of a shop you often go to. Consider the picture that comes before you minds’ eye.",
        "Finally, think of the front of a country scene which involves trees, mountains, and a lake. Consider the picture that comes before you minds’ eye."
      ];


      // Adjust the loop to chunk VVIQ items into groups of 4 and add to timeline with instructions
      for (let i = 0; i < vviq.length; i += 4) {
          let itemsChunk = vviq.slice(i, i + 4); // Use slice to avoid modifying the original array
          let instructionIndex = i / 4; // Calculate instruction index based on the current chunk
          timeline.push(generateVVIQTrial(itemsChunk, instructionIndex));
      }

      function generateVVIQTrial(itemsChunk, instructionIndex) {
          return {
              type: jsPsychSurveyMultiChoice,
              preamble: `<div class="vviq-instructions">${vviqInstructions[instructionIndex]}</div>`, // Include the prompt
              questions: itemsChunk.map(item => ({
                  prompt: item.item,
                  options: ['No image at all, I only "know" I am thinking of the object',
                            'Dim and vague image',
                            'Moderately realistic and vivid',
                            'Realistic and reasonably vivid',
                            'Perfectly realistic, as vivid as real seeing'],
                  required: true
              })),
              on_finish: function(data) {
                  // Data processing
                  data.item_ids = itemsChunk.map(i => i.item_id);
                  data.items = itemsChunk.map(i => i.item);
                  data.categories = itemsChunk.map(i => i.category);
                  data.questionnaires = itemsChunk.map(i => i.questionnaire);

                  //set progress bar value
                  var curr_progress_bar_value = jsPsych.getProgressBarCompleted();
                  jsPsych.setProgressBar(curr_progress_bar_value + (1/20));
              }
          };
      }

     var endExperiment = {
        type: jsPsychHtmlButtonResponse,
        stimulus: '<p><b>The End!</b><br><br>Thank you, you have completed the study.<br><br>Press next to be redirected back to SONA and receive credit for participation.</p>',
        
        choices: ['Continue']
        
      };
      timeline.push(endExperiment);

      const jsPsych = initJsPsych({
          timeline: timeline,

          //progress bar
          show_progress_bar: true,
          auto_update_progress_bar: false,
          message_progress_bar: 'Progress on Part II',

          on_finish: function() {
              var reshapedData = reshapeDataAndDisplay(); // Get reshaped data
              var filename = "wm_questionnaires_" + subject_id + ".json";
              // Convert reshaped data to JSON string for saving
              saveData(filename, reshapedData, function() {
                  // This callback function is executed after the data is successfully saved
                  window.location.assign("https://ucsd.sona-systems.com/webstudy_credit.aspx?experiment_id=2554&credit_token=74ee083f238648939dab04ebe27a4d6b&survey_code="+subject_id);
              });
          }
      });

      jsPsych.data.addProperties({
            subject_id: subject_id,
            sona_id: sona_id,
          });


      var exit_fullscreen = {
        type: jsPsychFullscreen,
        fullscreen_mode: false,
        delay_after: 0
      }
      timeline.push(exit_fullscreen);


      // Run the experiment
      jsPsych.run(timeline);
      </script>

      </body>
      </html>